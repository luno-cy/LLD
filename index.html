<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Structure SQL - Base de Données Scolaire</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <header>
            <h1>Documentation Base de Données</h1>
            <p>Script SQL de création des tables et des relations pour le système de gestion scolaire.</p>
        </header>

        <div class="code-window">
            <div class="code-header">
                <div class="buttons">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                </div>
                <span class="file-name">schema_ecole.sql</span>
            </div>
            <pre><code class="language-sql">
-- MLD du schma edusys
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE IF NOT EXISTS edusys.class (
    id_class BIGSERIAL PRIMARY KEY,
    class_name TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS edusys.parents (
    id_parent BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    surname TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    phone_number TEXT NOT NULL,
    email_digest TEXT
);

CREATE TABLE IF NOT EXISTS edusys.subject (
    id_subject BIGSERIAL PRIMARY KEY,
    subject_name TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS edusys.teacher (
    id_teacher BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    surname TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    phone_number TEXT NOT NULL,
    email_digest TEXT
);

CREATE TABLE IF NOT EXISTS edusys.user_ (
    id_user BIGSERIAL PRIMARY KEY,
    role TEXT NOT NULL CHECK (role IN ('teacher','parent','student','personel','admin')),
    id_teacher BIGINT UNIQUE REFERENCES edusys.teacher(id_teacher) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS edusys.messages (
    id_message BIGSERIAL PRIMARY KEY,
    content TEXT NOT NULL,
    id_user BIGINT NOT NULL REFERENCES edusys.user_(id_user) ON DELETE CASCADE,
    content_search tsvector
);

CREATE TABLE IF NOT EXISTS edusys.audit (
    id_audit_ BIGSERIAL PRIMARY KEY,
    time_ TIME NOT NULL,
    ip TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS edusys.type (
    id_type BIGSERIAL PRIMARY KEY,
    creation_action TEXT,
    modification_action TEXT,
    delete_action TEXT,
    id_audit_ BIGINT NOT NULL REFERENCES edusys.audit(id_audit_) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS edusys.inscription (
    id_inscription BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    surname TEXT NOT NULL,
    date_ DATE NOT NULL
);

CREATE TABLE IF NOT EXISTS edusys.grade (
    id_grade BIGSERIAL PRIMARY KEY,
    grade TEXT NOT NULL CHECK (grade ~ '^\\d+$' AND grade::integer >= 0 AND grade::integer <= 20),
    coefficient NUMERIC(4,2) CHECK (coefficient >= 0),
    id_subject BIGINT NOT NULL REFERENCES edusys.subject(id_subject) ON UPDATE RESTRICT ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS edusys.school (
    id_school BIGSERIAL PRIMARY KEY,
    school_name TEXT NOT NULL,
    address TEXT NOT NULL,
    telephone TEXT NOT NULL,
    id_inscription BIGINT NOT NULL REFERENCES edusys.inscription(id_inscription) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS edusys.student (
    id_student BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    surname TEXT NOT NULL,
    date_of_birth DATE NOT NULL,
    id_grade BIGINT NOT NULL REFERENCES edusys.grade(id_grade) ON DELETE CASCADE,
    id_class BIGINT NOT NULL REFERENCES edusys.class(id_class) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS edusys.personel (
    id_personel BIGSERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    surname TEXT NOT NULL,
    email TEXT NOT NULL UNIQUE,
    phone_number TEXT NOT NULL,
    id_school BIGINT NOT NULL REFERENCES edusys.school(id_school) ON DELETE CASCADE,
    id_user BIGINT NOT NULL UNIQUE REFERENCES edusys.user_(id_user) ON DELETE CASCADE,
    email_digest TEXT
);

CREATE TABLE IF NOT EXISTS edusys.absence (
    id_absence BIGSERIAL PRIMARY KEY,
    motif TEXT NOT NULL,
    justification TEXT NOT NULL,
    date_ DATE NOT NULL,
    id_student BIGINT NOT NULL REFERENCES edusys.student(id_student) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS edusys.authority (
    id_student BIGINT NOT NULL REFERENCES edusys.student(id_student) ON DELETE CASCADE,
    id_parent BIGINT NOT NULL REFERENCES edusys.parents(id_parent) ON DELETE CASCADE,
    PRIMARY KEY(id_student, id_parent)
);

CREATE TABLE IF NOT EXISTS edusys.teach (
    id_class BIGINT NOT NULL REFERENCES edusys.class(id_class) ON DELETE CASCADE,
    id_subject BIGINT NOT NULL REFERENCES edusys.subject(id_subject) ON DELETE CASCADE,
    PRIMARY KEY(id_class, id_subject)
);

CREATE TABLE IF NOT EXISTS edusys.present (
    id_parent BIGINT NOT NULL REFERENCES edusys.parents(id_parent) ON DELETE CASCADE,
    id_subject BIGINT NOT NULL REFERENCES edusys.subject(id_subject) ON DELETE CASCADE,
    id_teacher BIGINT NOT NULL REFERENCES edusys.teacher(id_teacher) ON DELETE CASCADE,
    PRIMARY KEY(id_parent, id_subject, id_teacher)
);

CREATE TABLE IF NOT EXISTS edusys.utilize (
    id_student BIGINT NOT NULL REFERENCES edusys.student(id_student) ON DELETE CASCADE,
    id_user BIGINT NOT NULL REFERENCES edusys.user_(id_user) ON DELETE CASCADE,
    PRIMARY KEY(id_student, id_user)
);

CREATE TABLE IF NOT EXISTS edusys.auditing (
    id_user BIGINT NOT NULL REFERENCES edusys.user_(id_user) ON DELETE CASCADE,
    id_audit_ BIGINT NOT NULL REFERENCES edusys.audit(id_audit_) ON DELETE CASCADE,
    PRIMARY KEY(id_user, id_audit_)
);

GRANT SELECT ON edusys.grade, edusys.absence, edusys.messages, edusys.student, edusys.utilize TO app_student;
GRANT SELECT ON edusys.grade, edusys.absence, edusys.messages, edusys.student, edusys.parents, edusys.authority TO app_parent;
GRANT SELECT, UPDATE ON edusys.grade, edusys.absence TO app_teacher;
GRANT SELECT ON edusys.messages TO app_teacher;
GRANT SELECT ON edusys.grade TO app_cpe;
GRANT SELECT, UPDATE ON edusys.absence, edusys.messages TO app_cpe;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA edusys to app_admin;
GRANT USAGE ON SCHEMA edusys TO app_student, app_parent, app_teacher, app_cpe, app_admin;

-- Grant usage on sequences for auto-incrementing IDs
GRANT USAGE ON ALL SEQUENCES IN SCHEMA edusys TO app_write, app_admin, app_teacher, app_cpe, app_vs;
ALTER DEFAULT PRIVILEGES IN SCHEMA edusys GRANT USAGE ON SEQUENCES TO app_write, app_admin, app_teacher, app_cpe, app_vs;

            </code></pre>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
</body>
</html>



